% Text written by Martin on 27jan2015
% Text modified by Tommy on 20apr2015

All sequence data generated in house will be processed homogeneously to avoid pipeline related artifacts.

\subsubsection{Alignment and preprocessing of reads}
Following generation of raw reads on the sequencing machine, the reads will be converted to BAM format using Illumina2BAM\footnote{https://github.com/wtsi-npg/illumina2bam}. Illumina2BAM will be used to de-multiplex the lanes that have been sequenced so that the tags are isolated from the body of the read, decoded, and can be used to separate out each lane into lanelets containing individual samples from the multiplex library and the PhiX control.  Reads corresponding to the PhiX control are mapped and used with Sanger’s spatial filter program\footnote{https://github.com/wtsi-npg/pb\_calibration} to identify reads from other lanelets that contain spatially oriented INDEL artefacts and mark them as QC fail. Mapping  of the Human samples is carried out using the BWA-MEM algorithm of the BWA software package, which is suitable for Illumina reads longer than 70bp\cite{2013arXiv1303.3997L}, with the GRCh37 1000 Genomes phase II reference (also known as hs37d5). PCR and optically duplicated reads are marked using Picard\footnote{http://broadinstitute.github.io/picard} MarkDuplicates.

\subsubsection{Quality control prior to variant calling}
In order to ensure the quality of the large quantity of BAMs produced for the project, an automatic quality control system is employed to reduce the number of data files that require manual intervention. This system has been derived from the one originally designed for the \href{http://www.uk10k.org}{UK10K  project} and uses a series of empirically derived thresholds to assess summary metrics calculated from the input BAMs. These thresholds include: percentage of reads mapped; percentage of duplicate reads marked; various statistics measuring indel distribution against read cycle and an insert size overlap percentage. Any lane that falls below the “fail” threshold for any of the metrics is excluded; any lane that falls below the “warn” threshold on a metric is manually examined; and any lane that does not fall below either of these thresholds for any of the metrics is given a status of “pass” and allowed to proceed into the later stages of the pipeline.
Table \ref{table:failQC} on page \pageref{table:failQC} summarises the samples failing the initial QC.
\input{ADRP/tables/failQC}

\subsubsection{Further preprocessing of reads}
Passed lanelets are then merged into BAMs corresponding to sample’s libraries with Picard MergeSamFiles and duplicates are marked again with Picard MarkDuplicates after which they are then merged into BAMs for each sample. Finally sample level bam improvement is carried out using GATK\cite{McKenna01092010}\cite{DePristo2011} and samtools\cite{Li15082009}. This consists of re-alignment of reads around known and discovered INDELs using GATK RealignerTargetCreator and IndelRealigner followed by base quality score recalibration (BQSR) using GATK BaseRecalibrator and PrintReads. Lastly samtools calmd is applied and indexes are created. Known indels for realignment are taken from the Mills Devine and 1000G Gold set and the 1000G phase 1 low coverage set both part of the Broad’s GATK resource bundle version 2.2. Known variants for BQSR are taken from dbSNP 137 also part of the Broad’s resource bundle.

\subsubsection{Further QC with verifyBamID prior to variant calling}
% Text written by Tommy prior to 20apr2015

Prior to variant calling we check for contamination (excess heterozygosity) and sample mix up (--best) with VerifyBamID\cite{Jun2012839} and require that the calculated FREEMIX is less than 0.05. We only check for sample mix (--best) for each sample when SNP array genotypes are available for that sample. To quantify the contamination more accurately for all samples we use the expected population allele frequency when available. We run with default settings and recommended options; i.e. --genoError 1.0e-03 --minAF 0.01 --minCallRate 0.50 --minMapQ 10 --maxDepth 20 --minQ 13 --maxQ 40 --grid 0.05 --refRef 1.00 --refHet 0.50 --refAlt 0.00 --ignoreRG. Because verifyBamID assumes the VCF to be well-formed (e.g. whether the REF allele actually matches with the reference sequence) we don't use PLINK to convert our SNP array data from bed to vcf, because PLINK saves the major allele A2 as the reference in all cases. Instead we use our own script, which uses the reference sequence as input in addition to the bed file. FREEMIX will otherwise be overestimated.
%Prior to variant calling we check the gender of the samples with GATK3.3+ DepthOfCoverage and require that the ratio between the non-PAR X and Y coverage is less than 2 and greater than 5 for males and females, respectively.
Table \ref{table:failVBI} on page \pageref{table:failVBI} summarises the samples failing verifyBamID.
\input{ADRP/tables/failVBI}
